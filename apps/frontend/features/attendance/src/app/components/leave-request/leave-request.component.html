<!-- Leave Management Dashboard -->
<div class="leave-management">
  <!-- Header Section -->
  <div class="header-section">
    <div class="header-content">
      <div>
        <h1>Leave Management</h1>
        <p>Manage your leave requests and view balances</p>
      </div>
      <lib-button
        label="Apply Leave"
        icon="pi pi-plus-circle"
        severity="primary"
        (clickEvent)="onOpenApplyLeaveDialog()">
      </lib-button>
    </div>
  </div>

  <!-- Leave Balance Overview -->
  <div class="balance-section">
    <lib-card title="Leave Balance Overview" subtitle="Your available and remaining leave days" shadow="md">
      <div class="balance-grid">
        @for (balance of leaveBalances(); track balance.leaveType) {
          <lib-stat-card
            [title]="getLeaveTypeLabel(balance.leaveType)"
            [value]="balance.remainingDays + ' / ' + balance.totalDays"
            [icon]="'pi pi-calendar'"
            [variant]="balance.remainingDays > balance.totalDays * 0.5 ? 'success' : balance.remainingDays > 0 ? 'warning' : 'danger'"
            size="small"
            [subtitle]="balance.usedDays + ' days used'">
          </lib-stat-card>
        }
      </div>

      <!-- Balance Summary -->
      <div class="balance-summary">
        <div class="summary-stat">
          <div class="summary-icon summary-icon--success">
            <i class="pi pi-check-circle"></i>
          </div>
          <div class="summary-content">
            <div class="summary-value">{{ totalLeaveBalance() }}</div>
            <div class="summary-label">Total Remaining Days</div>
          </div>
        </div>
        <div class="summary-stat">
          <div class="summary-icon summary-icon--info">
            <i class="pi pi-calendar-check"></i>
          </div>
          <div class="summary-content">
            <div class="summary-value">{{ usedLeaveBalance() }}</div>
            <div class="summary-label">Total Used Days</div>
          </div>
        </div>
      </div>
    </lib-card>
  </div>

  <!-- Main Content Grid -->
  <div class="content-grid">
    <!-- Left Column -->
    <div class="content-column">
      <!-- Past Leave Applications -->
      <lib-card title="Past Leave Applications" subtitle="Your previous leave requests" shadow="md">
        @if (pastLeaveRequests().length === 0) {
          <div class="empty-state">
            <i class="pi pi-inbox"></i>
            <p>No past leave applications</p>
          </div>
        } @else {
          <lib-table
            [columns]="pastLeaveTableColumns"
            [rows]="pastLeaveTableRows()"
            [config]="pastLeaveTableConfig"
            variant="default"
            [loading]="isLoading()">
          </lib-table>
        }
      </lib-card>

      <!-- Pending Leave Requests (for approval) -->
      @if (pendingLeaveRequests().length > 0) {
        <lib-card title="Pending Leave Requests" subtitle="Leave requests awaiting approval" shadow="md">
          <lib-table
            [columns]="pendingLeaveTableColumns"
            [rows]="pendingLeaveTableRows()"
            [config]="pendingLeaveTableConfig"
            variant="default"
            [loading]="isLoading()"
            (rowClick)="onPendingLeaveRowClick($event)"
            (actionClick)="onPendingLeaveActionClick($event)">
          </lib-table>
        </lib-card>
      }
    </div>

    <!-- Right Column -->
    <div class="content-column">
      <!-- Next Public Holiday -->
      @if (nextHoliday()) {
        <lib-card title="Next Public Holiday" subtitle="Upcoming holiday information" shadow="md">
          <div class="holiday-card">
            <div class="holiday-icon">
              <i class="pi pi-calendar"></i>
            </div>
            <div class="holiday-content">
              <h3>{{ nextHoliday()!.name }}</h3>
              <p class="holiday-date">{{ formatDate(nextHoliday()!.date) }}</p>
              <p class="holiday-days">{{ getDaysUntilHoliday(nextHoliday()!) }} days away</p>
              @if (nextHoliday()!.description) {
                <p class="holiday-description">{{ nextHoliday()!.description }}</p>
              }
            </div>
          </div>
        </lib-card>
      }

      <!-- Upcoming Holidays -->
      <lib-card title="Upcoming Holidays" subtitle="Next 5 public and company holidays" shadow="md">
        <div class="holidays-list">
          @for (holiday of upcomingHolidays(); track holiday.id) {
            <div class="holiday-item">
              <div class="holiday-item-icon" [class.holiday-item-icon--public]="holiday.type === 'public'" [class.holiday-item-icon--company]="holiday.type === 'company'">
                <i [class]="holiday.type === 'public' ? 'pi pi-globe' : 'pi pi-building'"></i>
              </div>
              <div class="holiday-item-content">
                <div class="holiday-item-name">{{ holiday.name }}</div>
                <div class="holiday-item-date">{{ formatDate(holiday.date) }}</div>
                @if (holiday.description) {
                  <div class="holiday-item-description">{{ holiday.description }}</div>
                }
              </div>
              <div class="holiday-item-days">
                {{ getDaysUntilHoliday(holiday) }}d
              </div>
            </div>
          }
        </div>
      </lib-card>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="charts-section">
    <div class="charts-grid">
      <!-- Leave Balance Distribution -->
      <lib-card title="Leave Balance Distribution" subtitle="Remaining days by leave type" shadow="md">
        <div class="chart-container">
          <lib-chart
            type="doughnut"
            [data]="leaveBalanceChartData()"
            [options]="leaveBalanceChartOptions"
            height="300px">
          </lib-chart>
        </div>
      </lib-card>

      <!-- Leave Usage Trend -->
      <lib-card title="Leave Usage Trend" subtitle="Used vs remaining days by leave type" shadow="md">
        <div class="chart-container">
          <lib-chart
            type="bar"
            [data]="leaveUsageChartData()"
            [options]="leaveUsageChartOptions"
            height="300px">
          </lib-chart>
        </div>
      </lib-card>
    </div>
  </div>
</div>

<!-- Apply Leave Dialog -->
<lib-dialog
  header="Apply for Leave"
  size="large"
  [(visible)]="showApplyLeaveDialog"
  (close)="onCloseApplyLeaveDialog()">
  
  <div class="dialog-content">
    <!-- Dynamic Form -->
    <lib-dynamic-form
      [config]="leaveFormConfigComputed()"
      (submit)="onLeaveFormSubmit($event)"
      (valueChange)="onLeaveFormValueChange($event)"
      (formGroupReady)="onDynamicFormReady($event)">
    </lib-dynamic-form>

    <!-- Total Days Display -->
    <div class="total-days-card">
      <div class="total-days-content">
        <div class="total-days-info">
          <i class="pi pi-calendar-times"></i>
          <div>
            <span class="total-days-label">Total Days</span>
            <span class="total-days-value" [class.total-days-value--error]="totalDays() > availableBalance() && selectedLeaveType()">
              {{ totalDays() || 0 }}
            </span>
          </div>
        </div>
        @if (selectedLeaveType() && availableBalance() > 0) {
          <div class="balance-info">
            <span class="balance-label">Balance:</span>
            <span class="balance-value">{{ availableBalance() }} days</span>
          </div>
        }
      </div>
      @if (totalDays() > availableBalance() && selectedLeaveType()) {
        <small class="field-error">
          <i class="pi pi-exclamation-triangle"></i>
          Exceeds available balance ({{ availableBalance() }} days)
        </small>
      }
      @if (selectedLeaveType() && availableBalance() > 0) {
        <small class="field-hint">
          <i class="pi pi-info-circle"></i>
          Available balance: {{ availableBalance() }} days
        </small>
      }
      @if (selectedLeaveType() && availableBalance() === 0) {
        <small class="field-error">
          <i class="pi pi-exclamation-circle"></i>
          No remaining balance for this leave type
        </small>
      }
    </div>

    <!-- Dialog Actions -->
    <div class="dialog-actions">
      <lib-button
        label="Cancel"
        icon="pi pi-times"
        severity="secondary"
        [outlined]="true"
        (clickEvent)="onCloseApplyLeaveDialog()">
      </lib-button>
      
      <lib-button
        label="Submit Request"
        icon="pi pi-send"
        severity="primary"
        [disabled]="!canSubmitRequest()"
        [loading]="isSubmitting()"
        (clickEvent)="onSubmitLeaveRequest()">
      </lib-button>
    </div>
  </div>
</lib-dialog>

<!-- Approval Dialog -->
<lib-dialog
  [header]="approvalAction() === 'approve' ? 'Approve Leave Request' : 'Reject Leave Request'"
  size="large"
  [(visible)]="showApprovalDialog"
  (close)="onCloseApprovalDialog()">
  
  @if (selectedRequestForApproval()) {
    <div class="approval-dialog">
      <!-- Request Summary -->
      <div class="request-summary">
        <h4>Request Summary</h4>
        <div class="summary-grid">
          <div class="summary-item">
            <span class="summary-label">Employee:</span>
            <span class="summary-value">{{ selectedRequestForApproval()!.employeeName }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Employee ID:</span>
            <span class="summary-value">{{ selectedRequestForApproval()!.employeeId }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Leave Type:</span>
            <span class="summary-value">{{ getLeaveTypeLabel(selectedRequestForApproval()!.leaveType) }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Duration:</span>
            <span class="summary-value">{{ formatDate(selectedRequestForApproval()!.startDate) }} - {{ formatDate(selectedRequestForApproval()!.endDate) }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Total Days:</span>
            <span class="summary-value">{{ selectedRequestForApproval()!.totalDays }} days</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Submitted:</span>
            <span class="summary-value">{{ formatDate(selectedRequestForApproval()!.submittedDate) }}</span>
          </div>
        </div>
      </div>

      <!-- Request Details -->
      <div class="request-details">
        <div class="detail-section">
          <h5>Reason:</h5>
          <p>{{ selectedRequestForApproval()!.reason }}</p>
        </div>

        @if (selectedRequestForApproval()!.emergencyContact) {
          <div class="detail-section">
            <h5>Emergency Contact:</h5>
            <p>{{ selectedRequestForApproval()!.emergencyContact }}</p>
          </div>
        }

        @if (selectedRequestForApproval()!.workHandover) {
          <div class="detail-section">
            <h5>Work Handover:</h5>
            <p>{{ selectedRequestForApproval()!.workHandover }}</p>
          </div>
        }
      </div>

      <!-- Approval Comments -->
      <div class="approval-form">
        <div class="form-field">
          <label for="approvalComments" class="field-label">Comments</label>
          <textarea
            id="approvalComments"
            [formControl]="approvalCommentsFormControl"
            placeholder="Add comments for this decision..."
            rows="4"
            class="form-textarea">
          </textarea>
        </div>
      </div>
    </div>

    <!-- Dialog Actions -->
    <div class="dialog-actions">
      <lib-button
        label="Cancel"
        icon="pi pi-times"
        severity="secondary"
        [outlined]="true"
        (clickEvent)="onCloseApprovalDialog()">
      </lib-button>
      
      <lib-button
        [label]="approvalAction() === 'approve' ? 'Approve Request' : 'Reject Request'"
        [icon]="approvalAction() === 'approve' ? 'pi pi-check' : 'pi pi-times'"
        [severity]="approvalAction() === 'approve' ? 'success' : 'danger'"
        [loading]="isProcessingApproval()"
        (clickEvent)="onProcessApproval()">
      </lib-button>
    </div>
  }
</lib-dialog>
