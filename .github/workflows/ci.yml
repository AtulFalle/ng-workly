name: CI

on:
  push:
    branches:
      - master
  pull_request:

permissions:
  actions: read
  contents: write  # Added for README updates

jobs:
  main:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # This enables task distribution via Nx Cloud
      # Run this command as early as possible, before dependencies are installed
      # Learn more at https://nx.dev/ci/reference/nx-cloud-cli#npx-nxcloud-startcirun
      # Uncomment this line to enable task distribution
      # - run: npx nx start-ci-run --distribute-on="3 linux-medium-js" --stop-agents-after="build"

      # Cache node_modules
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - run: npm ci --legacy-peer-deps
      
      # Install jq for JSON parsing
      - run: sudo apt-get update && sudo apt-get install -y jq

      # Run all checks and capture results
      - name: Run Lint Tests
        id: lint
        run: |
          echo "Running lint checks..."
          nx run-many -t lint --all --json > lint-results.json 2>&1 || true
          nx run-many -t lint --all > lint-results.txt 2>&1 || true
          LINT_ISSUES=$(jq -r '.results | length' lint-results.json 2>/dev/null || echo "0")
          LINT_STATUS=$([ "$LINT_ISSUES" -eq 0 ] && echo "PASS" || echo "FAIL")
          echo "lint_issues=$LINT_ISSUES" >> $GITHUB_OUTPUT
          echo "lint_status=$LINT_STATUS" >> $GITHUB_OUTPUT
          echo "Lint Status: $LINT_STATUS ($LINT_ISSUES issues)"

      - name: Run Tests
        id: test
        run: |
          echo "Running tests..."
          nx run-many -t test --all --json > test-results.json 2>&1 || true
          TEST_COUNT=$(jq -r '.results | length' test-results.json 2>/dev/null || echo "0")
          TEST_STATUS=$([ "$TEST_COUNT" -gt 0 ] && echo "PASS" || echo "FAIL")
          echo "test_count=$TEST_COUNT" >> $GITHUB_OUTPUT
          echo "test_status=$TEST_STATUS" >> $GITHUB_OUTPUT
          echo "Test Status: $TEST_STATUS ($TEST_COUNT test suites)"

      - name: Run Build
        id: build
        run: |
          echo "Running builds..."
          START_TIME=$(date +%s)
          nx run-many -t build --all --json > build-results.json 2>&1 || true
          END_TIME=$(date +%s)
          BUILD_DURATION=$((END_TIME - START_TIME))
          BUILD_COUNT=$(jq -r '.results | length' build-results.json 2>/dev/null || echo "0")
          BUILD_STATUS=$([ "$BUILD_COUNT" -gt 0 ] && echo "PASS" || echo "FAIL")
          echo "build_count=$BUILD_COUNT" >> $GITHUB_OUTPUT
          echo "build_status=$BUILD_STATUS" >> $GITHUB_OUTPUT
          echo "build_duration=$BUILD_DURATION" >> $GITHUB_OUTPUT
          echo "start_time=$START_TIME" >> $GITHUB_OUTPUT
          echo "Build Status: $BUILD_STATUS ($BUILD_COUNT projects) in ${BUILD_DURATION}s"
      - run: npx nx fix-ci
        if: always()

      - name: Run Chromatic
        uses: chromaui/action@latest
        with:
          # ⚠️ Make sure to configure a `CHROMATIC_PROJECT_TOKEN` repository secret
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}